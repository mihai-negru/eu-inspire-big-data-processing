#!/usr/bin/env bash

update_hosts_for_service() {
  local DNS_NAME="$1"
  local NAMESPACE="$2"
  local SERVICE_NAME="$3"

  echo "ğŸŒ Getting external IP of the LoadBalancer for $SERVICE_NAME in namespace $NAMESPACE..."

  EXTERNAL_IP=""
  TRIES=20
  while [[ -z "$EXTERNAL_IP" && $TRIES -gt 0 ]]; do
    EXTERNAL_IP=$(kubectl get svc "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
    if [[ -z "$EXTERNAL_IP" ]]; then
      echo "â³ Waiting for external IP of $SERVICE_NAME..."
      sleep 5
      ((TRIES--))
    else
      break
    fi
  done

  if [[ -z "$EXTERNAL_IP" ]]; then
    echo "âŒ Failed to retrieve external IP for service '$SERVICE_NAME' in namespace '$NAMESPACE'"
    exit 1
  fi

  echo "âœ… External IP for $SERVICE_NAME: $EXTERNAL_IP"

  echo "ğŸ“ Updating /etc/hosts to add: $DNS_NAME -> $EXTERNAL_IP"

  sudo sed -i '' "/[[:space:]]$DNS_NAME/d" /etc/hosts

  echo "$EXTERNAL_IP    $DNS_NAME" | sudo tee -a /etc/hosts > /dev/null

  echo "âœ… Mapped $DNS_NAME to $EXTERNAL_IP"
  echo "ğŸŒ You can now access: http://$DNS_NAME"
}